services:
  etcd:
    image: gcr.io/etcd-development/etcd:v3.5.15
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
    ports:
      - "2379:2379"

  yu-rpc-provider:
    build: .
    image: yu-rpc-demo:latest
    depends_on:
      - etcd
    environment:
      - SPRING_PROFILES_ACTIVE=provider
      - JAVA_OPTS=-Drpc.registryConfig.registry=etcd -Drpc.registryConfig.address=http://etcd:2379 -Drpc.telemetry.enabled=true -Drpc.telemetry.metricsEnabled=true -Drpc.telemetry.metricsExporter=prometheus -Drpc.telemetry.metricsPort=9404 -Drpc.telemetry.tracingExporter=logging
    restart: unless-stopped
    ports:
      - "9091:9091"
      - "9404:9404"

  yu-rpc-client:
    image: yu-rpc-demo:latest
    depends_on:
      - yu-rpc-provider
    environment:
      - SPRING_PROFILES_ACTIVE=client
      - JAVA_OPTS=-Drpc.registryConfig.registry=etcd -Drpc.registryConfig.address=http://etcd:2379 -Drpc.telemetry.enabled=true -Drpc.telemetry.metricsEnabled=true -Drpc.telemetry.metricsExporter=prometheus -Drpc.telemetry.metricsPort=9405 -Drpc.telemetry.tracingExporter=logging
    command: ["sh", "-c", "java $JAVA_OPTS -jar app.jar --spring.profiles.active=$SPRING_PROFILES_ACTIVE"]

  prometheus:
    image: prom/prometheus:v2.53.1
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    ports:
      - "9090:9090"
    depends_on:
      - yu-rpc-provider
      - yu-rpc-client

  grafana:
    image: grafana/grafana:11.1.0
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - "3000:3000"
    depends_on:
      - prometheus

